<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Travis STEM Night 2025: Teachable Machine Demo</title>

  <!-- TFJS + Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.13.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8;
      --a:#60a5fa; --b:#22c55e; --warn:#f59e0b; --danger:#ef4444; --pink:#f472b6; --vio:#a78bfa;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 10% -20%, #1f2937, transparent),
                  radial-gradient(1000px 500px at 110% 0%, #1f2937, transparent),
                  var(--bg);
      color:var(--text);
    }
    header{ padding:24px 16px; text-align:center; }
    h1{ margin:0 0 6px; font-size:clamp(24px,3vw,36px) }
    .sub{ color:var(--muted); font-size:clamp(14px,2vw,16px) }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px }
    .grid{ display:grid; gap:16px; grid-template-columns: 1.2fr 1fr; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr } }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.06);
      border-radius:16px; padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .stage{ display:grid; gap:12px; grid-template-rows: auto 1fr auto; min-height:520px; }
    .videoWrap{
      position:relative; border-radius:16px; overflow:hidden;
      background:#000; min-height:320px; display:flex; align-items:center; justify-content:center;
    }
    canvas, video{max-width:100%; height:auto; display:block}
    .badge{ position:absolute; top:12px; left:12px; background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.2); padding:6px 10px; border-radius:999px; font-size:12px }
    .overlay{
      position:absolute; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center;
      font-size:min(18vw,120px); font-weight:900; letter-spacing:1px;
      text-shadow:0 12px 36px rgba(0,0,0,0.6);
      opacity:0; transform:scale(.98); transition:opacity .15s ease, transform .15s ease;
    }
    .overlay.show{ opacity:1; transform:scale(1) }
    .overlayTag{
      position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
      padding:8px 14px; font-weight:800; border-radius:12px;
      background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25);
      font-size:clamp(14px,2.5vw,18px)
    }
    .controls{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center }
    button{
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.18); color:var(--text);
      padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
      transition:transform .08s ease, box-shadow .2s ease, background .2s ease;
      user-select:none; text-align:center; display:inline-flex; gap:8px; align-items:center;
    }
    button:hover{ transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.35) }
    button.primary{ border-color:rgba(34,197,94,.6); }
    button.warn{ border-color:rgba(245,158,11,.6); }
    button.ghost{ background:transparent; border-color:rgba(255,255,255,.12) }

    .pred{ display:grid; gap:14px; }
    .row{
      display:grid; grid-template-columns: auto 1fr auto; gap:10px; align-items:center;
      padding:10px; border-radius:12px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,.08)
    }
    .label{ display:flex; align-items:center; gap:10px; font-weight:800; font-size:18px }
    .emoji{ font-size:28px }
    .bar{ width:100%; height:14px; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.1) }
    .bar > span {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #60a5fa); /* green ‚Üí blue gradient */
      border-radius: 999px;
      transition: width 0.4s ease-out; /* smooth animation */
    }
    .pct{ min-width:64px; text-align:right; font-variant-numeric: tabular-nums; color:var(--muted) }
    .howto{ color:var(--muted); font-size:14px; line-height:1.5 }
    .howto ul{ margin:10px 0 0 18px }
  </style>
</head>
<body>
  <header>
    <h1>Travis STEM Night 2025: Google‚Äôs Teachable Machine Demo</h1>
    <div class="sub">Hold up an animal picture or toy to the camera ‚Äî the computer will try to recognize it!</div>
  </header>

  <div class="wrap grid">
    <section class="card stage" aria-label="Camera Stage">
      <div class="videoWrap" id="stage">
        <div class="badge" id="status">Loading model‚Ä¶</div>
        <div class="overlay" id="overlay">
          <div id="overlayText">LABEL</div>
          <div class="overlayTag" id="overlayPct">100%</div>
        </div>
      </div>

      <div class="controls">
        <button class="primary" id="startCam">üé• Start Camera</button>
        <button class="warn" id="stopCam">‚èπ Stop Camera</button>
        <button class="ghost" id="pause">‚è∏ Pause</button>
        <button class="ghost" id="resume">‚ñ∂Ô∏è Resume</button>
        <button class="ghost" id="reset">‚ôªÔ∏è Reset</button>
      </div>

      <div class="howto">
        <strong>Tips:</strong>
        <ul>
          <li>Fill the frame with the animal. Keep steady.</li>
          <li>Good light helps! Try not to block the camera.</li>
          <li>Try side angles ‚Äî see if the computer still gets it right.</li>
        </ul>
      </div>
    </section>

    <aside class="card pred" id="predictions"></aside>
  </div>

  <script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/eK4oESSAN/"; // <-- Replace with your model URL
    const THRESHOLD = 0.75, EMA_ALPHA = 0.35, LOCK_MS = 1000, LOOP_MS = 160;
    let model, webcam, running=false, usingWebcam=false, paused=false;
    let offscreenCanvas, offctx;
    let classNames=[];
    const classEmojis={"Hen":"üêî","Horse":"üêé","Sheep":"üêë","Cow":"üêÑ","Box":"üì¶"};
    const ema={}, stageEl=document.getElementById("stage");
    const overlayEl=document.getElementById("overlay"),overlayText=document.getElementById("overlayText"),overlayPct=document.getElementById("overlayPct");
    const statusEl=document.getElementById("status");
    const $=id=>document.getElementById(id);
    $("startCam").onclick=startCamera; $("stopCam").onclick=stopCamera;
    $("pause").onclick=()=>paused=true; $("resume").onclick=()=>paused=false; $("reset").onclick=resetAll;

    (async function init(){
      try{
        status("Loading model‚Ä¶");
        model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        const md = await fetch(MODEL_URL + "metadata.json?nocache=" + Date.now()).then(r => r.json());
        if(Array.isArray(md.labels)) classNames = md.labels;
        status("Model loaded ‚úì Click ‚ÄúStart Camera‚Äù to begin");
        setupPredictionsPanel();
        offscreenCanvas=document.createElement("canvas"); offscreenCanvas.width=400; offscreenCanvas.height=400;
        offctx=offscreenCanvas.getContext("2d",{alpha:false,desynchronized:true});
        classNames.forEach(n=>ema[n]=0);
      }catch(err){console.error(err);status("Error loading model. Check MODEL_URL.",true);}
    })();

    function setupPredictionsPanel(){
      const predDiv=document.getElementById("predictions");
      predDiv.innerHTML="";
      classNames.forEach((name,i)=>{
        const row=document.createElement("div");
        row.className="row";
        row.innerHTML=`<div class="label"><span class="emoji" id="emoji${i}">${classEmojis[name]||"üü¢"}</span><span id="name${i}">${name}</span></div>
                       <div class="bar"><span id="bar${i}"></span></div>
                       <div class="pct" id="pct${i}">0%</div>`;
        predDiv.appendChild(row);
      });
    }

    async function startCamera(){
      try{
        if(webcam){await webcam.stop();usingWebcam=false;}
        webcam=new tmImage.Webcam(400,400,true);
        await webcam.setup(); await webcam.play();
        usingWebcam=true; paused=false;
        attachCanvas(webcam.canvas);
        status("Camera running. Show an animal!");
        if(!running){running=true;loop();}
      }catch(err){console.error(err);status("Could not start camera.",true);}
    }
    async function stopCamera(){ if(webcam){await webcam.stop();usingWebcam=false;} status("Camera stopped."); hideOverlay(true); }
    function attachCanvas(c){[...stageEl.querySelectorAll("canvas, video, img")].forEach(n=>n.remove());c.style.display="block";stageEl.appendChild(c);}
    async function loop(){
      if(!running)return;
      if(usingWebcam&&webcam&&!paused){
        webcam.update();
        const preds=await model.predict(webcam.canvas);
        renderPreds(preds,false);
      }
      setTimeout(loop,LOOP_MS);
    }
    function renderPreds(preds,fromSnap=false){
      const map=Object.fromEntries(preds.map(p=>[p.className,p.probability]));
     classNames.forEach((n, i) => {
          const p = Math.max(0, Math.min(1, map[n] ?? 0));
          ema[n] = EMA_ALPHA * p + (1 - EMA_ALPHA) * (ema[n] ?? 0);
          const pct = (ema[n] * 100).toFixed(1) + "%";

          // get the <span> inside the .bar element for this row
          const barFill = document.querySelector(
            `#predictions .row:nth-child(${i + 1}) .bar > span`
          );
          const pctEl = $("pct" + i);

          if (barFill) barFill.style.width = pct;
          if (pctEl) pctEl.textContent = pct;
        });

      const best=classNames.map(n=>({name:n,p:ema[n]??0})).sort((a,b)=>b.p-a.p)[0];
      status(best.name+" ‚Ä¢ "+Math.round(best.p*100)+"%");
      if(best.p>=THRESHOLD){showOverlay(best.name,best.p);}
    }
    function showOverlay(label,p){
      overlayText.textContent=label.toUpperCase();
      overlayPct.textContent=Math.round(p*100)+"%";
      overlayEl.classList.add("show");
      setTimeout(()=>overlayEl.classList.remove("show"),LOCK_MS);
    }
    function hideOverlay(i=false){if(i)overlayEl.classList.remove("show");}
    function resetAll(){paused=false;hideOverlay(true);status("Reset.");classNames.forEach(n=>ema[n]=0);}
    function status(msg,e=false){statusEl.textContent=msg;
      statusEl.style.borderColor=e?"rgba(239,68,68,.6)":"rgba(96,165,250,.5)";
      statusEl.style.background=e?"rgba(239,68,68,.08)":"rgba(255,255,255,.08)";
    }
    function confettiBurst(){
      const c=document.createElement("canvas");c.width=stageEl.clientWidth;c.height=stageEl.clientHeight;
      c.style.position="absolute";c.style.inset=0;c.style.pointerEvents="none";stageEl.appendChild(c);
      const ctx=c.getContext("2d");const parts=Array.from({length:90},()=>({x:Math.random()*c.width,y:-10-Math.random()*50,dx:(Math.random()-0.5)*2,dy:2+Math.random()*3,s:4+Math.random()*4,a:1}));
      let t=0;(function anim(){ctx.clearRect(0,0,c.width,c.height);
        parts.forEach(p=>{p.x+=p.dx;p.y+=p.dy;p.a-=0.01;ctx.globalAlpha=Math.max(0,p.a);
          ctx.fillStyle=`hsl(${(p.x+p.y)%360},90%,60%)`;ctx.fillRect(p.x,p.y,p.s,p.s);});
        t++;if(t<100){requestAnimationFrame(anim);}else c.remove();})();
    }
  </script>
</body>
</html>
