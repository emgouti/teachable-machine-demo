<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teachable Machine ‚Äì Kid Mode (Stable Labels)</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.13.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --a:#60a5fa; --b:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -20%, #1f2937, transparent), var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui}
    header{padding:24px 16px;text-align:center}
    h1{margin:0 0 6px;font-size:clamp(22px,3vw,34px)}
    .sub{color:var(--muted);font-size:14px}
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .grid{display:grid;gap:16px;grid-template-columns:1.2fr 1fr}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .stage{position:relative;min-height:420px;border-radius:16px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}
    canvas{display:block;max-width:100%;height:auto;background:#000}
    .status{position:absolute;top:12px;left:12px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;font-size:12px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px}
    button{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.18);color:var(--text);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .pred{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px;border-radius:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
    .label{font-weight:800}
    .bar{width:100%;height:14px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
    .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--a),var(--b));transition:width .25s ease}
    .pct{min-width:64px;text-align:right;color:var(--muted);font-variant-numeric:tabular-nums}
    /* BIG overlay label when confident */
    .overlay{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;
      font-size:min(18vw,120px);font-weight:900;letter-spacing:2px;text-shadow:0 10px 30px rgba(0,0,0,.6);
      opacity:0;transition:opacity .12s ease, transform .12s ease; transform:scale(.98)
    }
    .overlay.show{opacity:1;transform:scale(1)}
    .overlay .bg {
      position:absolute;inset:auto 16px 16px 16px;bottom:24px;
      font-size:min(6vw,34px); font-weight:800; background:rgba(255,255,255,.1);
      border:1px solid rgba(255,255,255,.2); padding:8px 14px; border-radius:12px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Ball vs Cup ‚Äî Kid Mode</h1>
    <div class="sub">Shows a big, clear label only when the AI is confident.</div>
  </header>

  <div class="wrap grid">
    <section class="card">
      <div class="stage" id="stage">
        <div class="status" id="status">Loading model‚Ä¶</div>
        <!-- webcam canvas will be attached here -->
        <div class="overlay" id="overlay">
          <span id="overlayText">BALL</span>
          <div class="bg" id="overlayPct">99%</div>
        </div>
      </div>
      <div class="controls">
        <button id="start">üé• Start Camera</button>
        <button id="stop">‚èπ Stop</button>
      </div>
    </section>

    <aside class="card pred" aria-live="polite">
      <div class="row">
        <div class="label" id="name0">Ball</div>
        <div class="bar"><span id="bar0"></span></div>
        <div class="pct" id="pct0">0%</div>
      </div>
      <div class="row">
        <div class="label" id="name1">Cup</div>
        <div class="bar"><span id="bar1"></span></div>
        <div class="pct" id="pct1">0%</div>
      </div>
      <div class="sub">Smoothing + thresholding keeps the display calm and kid-friendly.</div>
    </aside>
  </div>

  <script>
    // üëâ replace with your model (must end with '/')
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/MjZdIoucw/";

    // kid-mode tuning
    const EMA_ALPHA = 0.35;          // smoothing factor (0..1). lower = smoother
    const THRESH_ON = 0.85;          // show label when best >= 85%
    const THRESH_OFF = 0.70;         // hide label only when best < 70% (hysteresis)
    const LOCK_MS = 1000;            // after showing, lock for 1 second
    const LOOP_MS = 180;             // prediction cadence (ms). 180ms ‚âà ~5 FPS visual update

    let model, webcam, maxClasses = 0;
    let classNames = ["Ball", "Cup"];
    let ema = {};                    // {className: smoothedProb}
    let overlayLockedUntil = 0;
    let showing = false;
    let running = false;

    const $ = id => document.getElementById(id);
    const statusEl = $("status");
    const overlay = $("overlay");
    const overlayText = $("overlayText");
    const overlayPct = $("overlayPct");
    const stage = $("stage");

    $("start").onclick = startCamera;
    $("stop").onclick  = stopCamera;

    (async function init(){
      try{
        model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        const md = await fetch(MODEL_URL + "metadata.json").then(r=>r.json());
        if (md.labels && md.labels.length >= 2) {
          classNames = [md.labels[0], md.labels[1]];
          $("name0").textContent = classNames[0];
          $("name1").textContent = classNames[1];
        }
        maxClasses = model.getTotalClasses();
        status("Model loaded ‚úì  Click Start Camera");
      }catch(e){
        console.error(e);
        status("Failed to load model. Check MODEL_URL.", true);
      }
    })();

    async function startCamera(){
      try{
        if (webcam) await webcam.stop();
        webcam = new tmImage.Webcam(400, 400, true);
        await webcam.setup();
        await webcam.play();
        attachCanvas(webcam.canvas);
        Object.fromEntries(classNames.map(n=>[n,0])).forEach?.(()=>{});
        ema = {}; classNames.forEach(n=>ema[n]=0);
        running = true;
        status("Camera running. Hold up the object!");
        loop();
      }catch(e){
        console.error(e);
        status("Camera blocked. Allow permission.", true);
      }
    }
    async function stopCamera(){
      running = false;
      try{ if (webcam) await webcam.stop(); } catch(e){}
      status("Stopped.");
      hideOverlay(true);
    }

    function attachCanvas(canvas){
      [...stage.querySelectorAll("canvas, video")].forEach(n=>n.remove());
      canvas.style.display = "block";
      stage.appendChild(canvas);
    }

    function status(msg, err=false){
      statusEl.textContent = msg;
      statusEl.style.borderColor = err ? "rgba(239,68,68,.6)" : "rgba(96,165,250,.5)";
      statusEl.style.background = err ? "rgba(239,68,68,.08)" : "rgba(255,255,255,.08)";
    }

    async function loop(){
      if (!running) return;
      try{
        webcam.update();
        const preds = await model.predict(webcam.canvas);
        renderSmoothed(preds);
        updateOverlay(preds);
      }catch(e){ console.error(e); }
      setTimeout(loop, LOOP_MS);
    }

    function renderSmoothed(preds){
      // update EMA for each class in metadata order
      const map = Object.fromEntries(preds.map(p=>[p.className, p.probability]));
      classNames.forEach((name, i)=>{
        const p = map[name] ?? 0;
        ema[name] = EMA_ALPHA * p + (1-EMA_ALPHA) * (ema[name] ?? 0);
        const pct = (ema[name]*100).toFixed(1) + "%";
        $("bar"+i).style.width = pct;
        $("pct"+i).textContent = pct;
      });
    }

    function updateOverlay(preds){
      // find best class using smoothed values
      const best = classNames
        .map(n => ({name:n, p: ema[n] ?? 0}))
        .sort((a,b)=>b.p-a.p)[0];

      const now = performance.now();
      const confident = best.p >= THRESH_ON;
      const belowOff  = best.p < THRESH_OFF;

      // lock window: once shown, keep it for LOCK_MS
      const inLock = now < overlayLockedUntil;

      if (!showing && confident && !inLock) {
        showOverlay(best.name, best.p);
        overlayLockedUntil = now + LOCK_MS;
        showing = true;
      } else if (showing && belowOff && !inLock) {
        hideOverlay();
        showing = false;
      } else if (showing) {
        // update percentage text while visible
        overlayPct.textContent = Math.round(best.p*100) + "%";
      }
    }

    function showOverlay(label, p){
      overlayText.textContent = label.toUpperCase();
      overlayPct.textContent = Math.round(p*100) + "%";
      overlay.classList.add("show");
    }
    function hideOverlay(immediate=false){
      if (immediate) {
        overlay.classList.remove("show");
        return;
      }
      overlay.classList.remove("show");
    }
  </script>
</body>
</html>
