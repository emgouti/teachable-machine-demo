<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STEM Night â€” Train Your Own AI (Ball vs Cup)</title>

  <!-- TensorFlow.js + MobileNet + KNN Classifier (CDN builds) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.13.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier@1.2.2"></script>

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8;
      --a:#60a5fa; --b:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -20%, #1f2937, transparent), var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui}
    header{padding:24px 16px;text-align:center}
    h1{margin:0 0 8px;font-size:clamp(24px,3vw,36px)}
    .sub{color:var(--muted)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px;grid-template-columns:1.2fr 1fr}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}

    .stage{display:grid;gap:12px;grid-template-rows:auto 1fr auto}
    .videoWrap{position:relative;border-radius:16px;overflow:hidden;background:#000;min-height:320px;
      display:flex;align-items:center;justify-content:center}
    video,canvas{max-width:100%;height:auto;display:block}
    .badge{position:absolute;top:12px;left:12px;background:rgba(255,255,255,.1);
      border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;font-size:12px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    button,label.button{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.18);color:var(--text);padding:10px 14px;border-radius:12px;font-weight:700;
      cursor:pointer;user-select:none;display:inline-flex;align-items:center;gap:8px}
    button:hover,label.button:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.35)}
    button.primary{border-color:rgba(96,165,250,.7)}
    button.good{border-color:rgba(34,197,94,.6)}
    button.warn{border-color:rgba(245,158,11,.6)}
    button.danger{border-color:rgba(239,68,68,.6)}
    input[type=file]{display:none}

    .pred{display:grid;gap:14px}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px;border-radius:12px;
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
    .label{display:flex;gap:10px;align-items:center;font-weight:800;font-size:18px}
    .emoji{font-size:30px}
    .bar{width:100%;height:14px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
    .bar > span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--a),var(--b));transition:width .3s ease}
    .pct{min-width:64px;text-align:right;color:var(--muted);font-variant-numeric:tabular-nums}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);padding:4px 8px;border-radius:999px;font-size:12px}
    .count{font-weight:800}
    .howto{color:var(--muted);font-size:14px}
    .howto ul{margin:8px 0 0 18px}
  </style>
</head>
<body>
  <header>
    <h1>Train Your Own AI â€” Ball vs Cup</h1>
    <div class="sub">Kinderâ€“5th â€¢ Collect examples, train, then test live with your webcam!</div>
  </header>

  <div class="wrap grid">
    <!-- LEFT: Camera + Trainer -->
    <section class="card stage" aria-label="Camera & Trainer">
      <div class="videoWrap" id="stage">
        <div class="badge" id="status">Loading MobileNetâ€¦</div>
        <video id="webcam" autoplay playsinline muted></video>
      </div>

      <div class="controls" role="group" aria-label="Collect examples">
        <button class="primary" id="startCam">ğŸ¥ Start Camera</button>
        <button id="pause">â¸ Pause</button>
        <button id="resume">â–¶ï¸ Resume</button>
        <button class="warn" id="clear">ğŸ§¹ Clear All</button>
      </div>

      <div class="controls" role="group" aria-label="Training buttons">
        <button class="good" id="addBall">â• Add â€œBallâ€ Example (<span class="count" id="cBall">0</span>)</button>
        <button class="good" id="addCup">â• Add â€œCupâ€ Example (<span class="count" id="cCup">0</span>)</button>
        <button id="train">ğŸ Start Predicting</button>
        <label class="button" for="file">ğŸ–¼ Upload Photo</label>
        <input id="file" type="file" accept="image/*" />
        <button class="danger" id="download">â¬‡ï¸ Save Classifier</button>
        <label class="button" for="upload">â¬†ï¸ Load Classifier</label>
        <input id="upload" type="file" accept="application/json" />
      </div>

      <div class="howto">
        <strong>How it works:</strong>
        <ul>
          <li>Hold a <em>ball</em> in front of the camera and press â€œAdd Ball Exampleâ€ a few times (5â€“20).</li>
          <li>Do the same for a <em>cup</em>.</li>
          <li>Press â€œStart Predictingâ€ and watch the bars move!</li>
          <li>No camera? Upload a photo instead.</li>
        </ul>
      </div>
    </section>

    <!-- RIGHT: Predictions -->
    <aside class="card pred" aria-live="polite" aria-atomic="true">
      <div class="row">
        <div class="label"><span class="emoji">ğŸ€</span> <span>Ball</span></div>
        <div class="bar"><span id="barBall"></span></div>
        <div class="pct" id="pctBall">0%</div>
      </div>
      <div class="row">
        <div class="label"><span class="emoji">ğŸ¥¤</span> <span>Cup</span></div>
        <div class="bar"><span id="barCup"></span></div>
        <div class="pct" id="pctCup">0%</div>
      </div>

      <div class="howto">
        <strong>Whatâ€™s happening?</strong> We use a pre-trained vision model (MobileNet) to turn the camera image into a feature vector,
        then a simple <em>KNN classifier</em> learns your two categories using your examples â€” training happens on the device, instantly.
      </div>
    </aside>
  </div>

  <script>
    // --- Globals ---
    let net, classifier, webcamStream = null, paused = false, predicting = false;
    const video = document.getElementById('webcam');
    const statusEl = document.getElementById('status');
    const counts = {Ball:0, Cup:0};

    const barBall = document.getElementById('barBall');
    const barCup  = document.getElementById('barCup');
    const pctBall = document.getElementById('pctBall');
    const pctCup  = document.getElementById('pctCup');

    // --- Utility DOM helpers ---
    const $ = id => document.getElementById(id);
    function setStatus(t, isErr=false){
      statusEl.textContent = t;
      statusEl.style.borderColor = isErr ? "rgba(239,68,68,.6)" : "rgba(96,165,250,.5)";
      statusEl.style.background = isErr ? "rgba(239,68,68,.08)" : "rgba(255,255,255,.08)";
    }

    // --- Load MobileNet + init KNN ---
    (async function boot(){
      try{
        setStatus("Loading MobileNetâ€¦");
        net = await mobilenet.load({version:2, alpha:1.0}); // higher accuracy
        classifier = knnClassifier.create();
        setStatus("Ready. Start the camera and add examples!");
      }catch(err){
        console.error(err);
        setStatus("Failed to load model. Check network.", true);
      }
    })();

    // --- Camera controls ---
    $('startCam').onclick = async () => {
      try{
        if (webcamStream) { webcamStream.getTracks().forEach(t=>t.stop()); }
        webcamStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
        video.srcObject = webcamStream;
        await video.play();
        setStatus("Camera running. Add examples!");
      }catch(err){
        console.error(err);
        setStatus("Camera blocked. Use Upload Photo instead.", true);
      }
    };
    $('pause').onclick  = () => { paused = true; setStatus("Paused."); };
    $('resume').onclick = () => { paused = false; setStatus("Resumed."); };

    // --- Capture helpers ---
    function captureTensorFromVideo(){
      const tmp = document.createElement('canvas');
      const size = Math.min(video.videoWidth, video.videoHeight) || 224;
      tmp.width = 224; tmp.height = 224;
      const ctx = tmp.getContext('2d');
      // center-crop to square then shrink to 224x224
      const sx = ((video.videoWidth  || size) - size)/2;
      const sy = ((video.videoHeight || size) - size)/2;
      ctx.drawImage(video, sx, sy, size, size, 0, 0, 224, 224);
      const img = tf.browser.fromPixels(tmp);
      return img.expandDims(0); // shape [1,224,224,3]
    }

    async function addExample(label){
      if (!net) return;
      let img;
      if (video.srcObject && !video.paused && !video.ended) {
        img = captureTensorFromVideo();
      } else if (lastUpload) {
        img = lastUpload.clone();
      } else {
        setStatus("No camera feed or uploaded photo.", true);
        return;
      }
      const activation = net.infer(img, 'conv_preds');
      classifier.addExample(activation, label);
      img.dispose();
      counts[label]++; updateCounts();
    }

    function updateCounts(){
      $('cBall').textContent = counts.Ball;
      $('cCup').textContent  = counts.Cup;
    }

    // --- Upload photo (fallback or supplement) ---
    let lastUpload = null;
    $('file').onchange = async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const imgEl = new Image();
      imgEl.onload = async ()=>{
        const tmp = document.createElement('canvas');
        const size = Math.min(imgEl.width, imgEl.height);
        tmp.width = 224; tmp.height = 224;
        tmp.getContext('2d').drawImage(
          imgEl,
          (imgEl.width-size)/2, (imgEl.height-size)/2, size, size,
          0, 0, 224, 224
        );
        lastUpload?.dispose?.();
        lastUpload = tf.browser.fromPixels(tmp).expandDims(0);
        setStatus("Photo ready. Add examples or start predicting.");
      };
      imgEl.src = URL.createObjectURL(file);
    };

    // --- Buttons to add examples ---
    $('addBall').onclick = ()=> addExample('Ball');
    $('addCup').onclick  = ()=> addExample('Cup');

    // --- Clear / Reset ---
    $('clear').onclick = ()=>{
      classifier = knnClassifier.create();
      counts.Ball = counts.Cup = 0;
      updateCounts();
      setStatus("Cleared. Add new examples!");
    };

    // --- Save / Load classifier (optional) ---
    $('download').onclick = async ()=>{
      const dataset = classifier.getClassifierDataset();
      const entries = Object.entries(dataset).map(([k, v]) => [k, Array.from(v.dataSync())]);
      const json = JSON.stringify(entries);
      const blob = new Blob([json], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'knn-classifier.json';
      a.click();
    };
    $('upload').onchange = async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const text = await file.text();
      const entries = JSON.parse(text);
      const dataset = {};
      entries.forEach(([k, arr])=>{
        const tensor = tf.tensor(arr, [arr.length/1024, 1024]); // conv_preds size for MobileNet v2
        dataset[k] = tensor;
      });
      classifier.setClassifierDataset(dataset);
      // Make a guess at counts (not exact, but fine for demo)
      counts.Ball = dataset['0'] ? dataset['0'].shape[0] : counts.Ball;
      counts.Cup  = dataset['1'] ? dataset['1'].shape[0] : counts.Cup;
      updateCounts();
      setStatus("Classifier loaded. Start predicting!");
    };

    // --- Start Predicting (loop) ---
    $('train').onclick = ()=>{
      if (classifier.getNumClasses() < 2) {
        setStatus("Add examples for BOTH classes first.", true);
        return;
      }
      predicting = true;
      setStatus("Predictingâ€¦ show the object!");
      loop();
    };

    async function loop(){
      if (!predicting) return;
      if (!paused) {
        let img;
        if (video.srcObject && !video.paused && !video.ended) {
          img = captureTensorFromVideo();
        } else if (lastUpload) {
          img = lastUpload.clone();
        }
        if (img) {
          const activation = net.infer(img, 'conv_preds');
          const result = await classifier.predictClass(activation, 3); // top-k = 3
          render(result);
          img.dispose();
        }
      }
      requestAnimationFrame(loop);
    }

    function render(result){
      // result.label is "Ball" or "Cup"
      // result.confidencesByLabel like {Ball:0.87, Cup:0.13}
      const cb = result.confidencesByLabel || {};
      const pBall = Math.max(0, Math.min(1, cb['Ball'] || 0));
      const pCup  = Math.max(0, Math.min(1, cb['Cup']  || 0));
      barBall.style.width = (pBall*100).toFixed(1) + '%';
      barCup.style.width  = (pCup*100).toFixed(1) + '%';
      pctBall.textContent = (pBall*100).toFixed(1) + '%';
      pctCup.textContent  = (pCup*100).toFixed(1) + '%';
      setStatus(`Best: ${result.label} â€¢ ${(Math.max(pBall,pCup)*100).toFixed(1)}%`);
    }
  </script>
</body>
</html>
